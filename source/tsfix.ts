import debug from 'debug'
// fast-glob is a cjs module
// eslint-disable-next-line import-x/no-named-as-default
import glob from 'fast-glob'
import { performance } from 'node:perf_hooks'
import { setupOptions } from './helpers/options.ts'
import { getPackageDependencies } from './helpers/package.ts'
import { processFile } from './processor.ts'
import type { Args } from './types.ts'

const log = debug('tsfix:main')

/**
 * Fixes import statements in files generated by TypeScript compiler.
 *
 * @param args - The arguments passed to the function. It includes the pattern to search for files and options for the glob library.
 */
export const tsFix = async (args: Args): Promise<void> => {
  const dependencies = await getPackageDependencies()
  const { pattern, options, mode } = setupOptions(args)

  log('Searching for files with extensions: %s', pattern)
  log('Using build directory: %s', options.cwd)
  log('Using extraction mode: %s', mode)

  let processedFiles = 0
  const startTime = performance.now()
  const stream = glob.stream(pattern, options)

  for await (const filePath of stream) {
    await processFile(filePath, dependencies, mode)
    processedFiles++
  }

  const endTime = performance.now()
  const duration = (endTime - startTime).toFixed(2)
  console.log('Successfully fixed imports in %d files (%sms)', processedFiles, duration)
}
